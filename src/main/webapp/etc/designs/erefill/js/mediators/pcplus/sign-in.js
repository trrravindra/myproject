define(["jquery","stapes","../globals","json!config","jquery.validate","modules/managers/cookie-manager"],function(e,t,n,r,i,s){function p(){u=e(".sign-in-form"),a=e(".remember-me"),f=e("[name=email]"),l=e(".sign-in-error").not(".hidden")}function d(e){o.on("domready",v),u.on("submit",function(e){e.preventDefault()})}function v(){l.length>0&&w(E()),m(),g()}function m(){var t=window.location.pathname;if(t.indexOf("reset-password.html")>-1||t.indexOf("reset-password.php")>-1)t=t.replace(/.html|.php/,"-confirmation.html"),e.cookie.raw=!0,n.cookieManager.setCookie("SVP",t),e.cookie.raw=!1}function g(){var t=e(".form-errors");u.validate({errorClass:"invalid",errorContainer:".form-errors",errorElement:"p",onkeyup:!1,onclick:!1,onfocusout:!1,errorPlacement:function(e,n){l.length>0&&l.addClass("hidden"),t.append(e)},invalidHandler:function(e,t){var n=E();w(n,t.errorList)},submitHandler:function(t){var n=e(".sign-in-form").attr("class"),i=e(".remember-me").is(":checked");if(n.indexOf("user-login-form")!=-1){var s=e("input[name='email']").val(),o=e("input[name='password']").val(),u="",a=self.cookieManager.getCookieByName("redirect_url");typeof a!="undefined"?u=a:u=e(".redirectPage").val(),e.ajax({beforeSend:function(e){e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.setRequestHeader("Accept","text/html")},type:"PUT",url:"http://localhost:8080/lcl-pcplus-services/api/rest/v1/services/en/authentication",data:"email="+s+"&password="+o+"&redirectURL="+u+"&navFromNationalOffers=true",cache:!1,success:function(t){t=decodeURIComponent(t),t=e.parseJSON(t);var n=encodeURIComponent(JSON.stringify(t.authenticationInfo.memberInfo)),s=encodeURIComponent(JSON.stringify(t.authenticationInfo.userStatus));r.cookieDomain=="localhost"?(document.cookie="cqssoid="+n+";path=/;",document.cookie="user_stat="+s+";path=/",i&&(document.cookie="pcplus_signin_email="+t.authenticationInfo.signedInEmail+";path=/")):(document.cookie="cqssoid="+n+";path=/;domain="+r.cookieDomain,document.cookie="user_stat="+s+";path=/;domain="+r.cookieDomain,i&&(document.cookie="pcplus_signin_email="+t.authenticationInfo.signedInEmail+";path=/;domain="+r.cookieDomain)),location.href=t.redirectUrl},error:function(t,n,r){var i=decodeURIComponent(t.responseText);i=e.parseJSON(i);var s=i.exception,o="<p class='invalid'>"+s+"</p>";e(".sign-in-error").html(o),e(".sign-in-error").removeClass("hidden")}})}else if(n.indexOf("forgot-password-1")!=-1){var s=e("input[name='forgotpasswordemail']").val(),u=e(".redirectPage").val();e.ajax({beforeSend:function(e){e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.setRequestHeader("Accept","text/html")},type:"PUT",url:"http://localhost:8080/lcl-pcplus-services/api/rest/v1/services/en/security/challenge/qanda",data:"email="+s+"&redirectURL="+u,cache:!1,success:function(t){t=decodeURIComponent(t),t=e.parseJSON(t);var n=encodeURIComponent(JSON.stringify(t.userSecretQandA.memberInfo));r.cookieDomain=="localhost"?document.cookie="secqa="+n+";path=/;":document.cookie="secqa="+n+";path=/;domain="+r.cookieDomain,location.href=t.redirectUrl},error:function(t,n,r){var i=decodeURIComponent(t.responseText);i=e.parseJSON(i);var s=i.exception,o="<p class='invalid'>"+s+"</p>";e(".sign-in-error").html(o),e(".sign-in-error").removeClass("hidden")}})}else if(n.indexOf("forgot-password-2")!=-1){var f=e("input[name='answer']").val(),l=self.cookieManager.getCookieByName("secqa"),c=l.sec_a,h=l.mid,u=e(".redirectPage").val();e.ajax({beforeSend:function(e){e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.setRequestHeader("Accept","text/html")},type:"PUT",url:"http://localhost:8080/lcl-pcplus-services/api/rest/v1/services/en/security/challenge/validate",data:"userSecurityAnswer="+c+"&userEnteredAnswer="+f+"&membershipId="+h+"&redirectURL="+u,cache:!1,success:function(t){t=decodeURIComponent(t),t=e.parseJSON(t);var n=encodeURIComponent(JSON.stringify(t.challengeToken));r.cookieDomain=="localhost"?document.cookie="secqa_token="+n+";path=/;":document.cookie="secqa_token="+n+";path=/;domain="+r.cookieDomain,location.href=t.redirectUrl},error:function(t,n,r){var i=decodeURIComponent(t.responseText);i=e.parseJSON(i);var s=i.exception,o="<p class='invalid'>"+s+"</p>";e(".sign-in-error").html(o),e(".sign-in-error").removeClass("hidden")}})}if(n.indexOf("reset-password")!=-1){var p=decodeURIComponent(self.cookieManager.getCookieByName("secqa_token")),d=decodeURIComponent(self.cookieManager.getCookieByName("secqa"));d=e.parseJSON(d);var v=e(".new-password").val(),m=encodeURIComponent(d.mid),g=encodeURIComponent(p),u=e(".redirectPage").val(),y=e(".captchaValue").val(),b=e(".captchaKey").val();e.ajax({beforeSend:function(e){e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.setRequestHeader("Accept","text/html")},type:"PUT",url:"http://localhost:8080/lcl-pcplus-services/api/rest/v1/services/en/security/password",data:"membershipId="+m+"&challengeToken="+g+"&newPassword="+v+"&redirectURL="+u+"&captcha="+y+"&captchaKey="+b+"&navFromNationalOffers=true",cache:!1,success:function(t){t=decodeURIComponent(t),t=e.parseJSON(t);var n=encodeURIComponent(JSON.stringify(t.authenticationInfo.memberInfo)),i=encodeURIComponent(JSON.stringify(t.authenticationInfo.userStatus));r.cookieDomain=="localhost"?(document.cookie="cqssoid="+n+";path=/;",document.cookie="user_stat="+i+";path=/",document.cookie="secqa_token=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/",document.cookie="secqa=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/"):(document.cookie="cqssoid="+n+";path=/;domain="+r.cookieDomain,document.cookie="user_stat="+i+";path=/;domain="+r.cookieDomain,document.cookie="secqa_token=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/;domain="+r.cookieDomain,document.cookie="secqa=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/;domain="+r.cookieDomain),location.href=t.redirectUrl},error:function(t,n,r){var i=decodeURIComponent(t.responseText);i=e.parseJSON(i);var s=i.exception,o="<p class='invalid'>"+s+"</p>";e(".sign-in-error").html(o),e(".sign-in-error").removeClass("hidden")}})}}})}function y(e){c=a.prop("checked")}function b(){var t=n.cookieManager.getCookieByName(h.REMEMBER_ME_COOKIE_NAME);if(typeof t!="undefined"){f.val(t);var r=a.prop("checked",!0);typeof e.uniform!="undefined"&&e.uniform.update(r)}}function w(t,r){var i={category:"pc plus",value:"",event:"GA Event"},s="",o=", ";typeof r!="undefined"&&e.each(r,function(e,t){s+=t.message||"",e!==r.length-1&&(s+=o)});var u=e(".sign-in-error").not(".hidden");u.length>0&&(s.length>0&&(s+=o),s+=u.text()),i.label=s;switch(t){case h.pageTemplates.SIGN_IN:i.action="form errors:sign in";break;case h.pageTemplates.FP_STEP_ONE:i.action="form errors:password recovery:email address";break;case h.pageTemplates.FP_STEP_TWO:i.action="form errors:password recovery:secret question";break;case h.pageTemplates.FP_STEP_THREE:i.action="form errors:password recovery:new password";break;default:i.action="form errors:sign in"}n.fireAnalytics(i)}function E(){return u.find("[name=email]").length>0?u.find("[name=password]").length>0?h.pageTemplates.SIGN_IN:h.pageTemplates.FP_STEP_ONE:u.find("[name=answer]").length>0?h.pageTemplates.FP_STEP_TWO:h.pageTemplates.FP_STEP_THREE}var o,u,a,f,l,c=!1,h={REMEMBER_ME_COOKIE_NAME:"pcplus_signin_email",pageTemplates:{SIGN_IN:"sign-in",FP_STEP_ONE:"fp-step-one",FP_STEP_TWO:"fp-step-two",FP_STEP_THREE:"fp-step-three"}};self.cookieManager=new s;var S=t.subclass({constructor:function(){o=this,p(),d(),b(),e(function(){o.emit("domready")})}});return new S});