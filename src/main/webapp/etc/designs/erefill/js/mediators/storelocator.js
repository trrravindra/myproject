define(["jquery","stapes","modules/api-tools","./globals","modules/store-markers","tpl!templates/global.store-result.html","modules/format","i18n!nls/speak"],function(e,t,n,r,i,s,o,u){var a="storeIdCookie",f="storeNumCookie",l="storeNameCookie",c="storeProvienceCookie",h=e.parseJSON(e("input[name='storelocator']").val()),p=t.subclass({constructor:function(){var t=this;t.bindEvents(),t.storeIdCookie="storeIdCookie",t.storeNameCookie="storeNameCookie",t.storeNumCookie="storeNumCookie",h.departments&&h.departments==="4300002"&&t.setupSearchForPCPlus(),e(function(){t.emit("domready")})},setupSearchForPCPlus:function(){var t=e("#form-store-locator"),n=t.find('.departments input[type="checkbox"]'),r=n.filter("[value=4300002]");r.length>0&&r.prop("checked",!0).closest("span").addClass("checked")},bindEvents:function(){var e=this;e.on("domready",e.onDomReady)},localizetxt:function(){e(".page-details.locator .content h1").html(u.header),e(".page-details.locator .store-locator h4").html(u.searchlbl),e(".page-details.locator .store-listing .store-info .store-hours a").text(u.storehr),e(".page-details.locator .store-listing .store-services a").html(u.storesrv),e(".store-locator form input[type='text']").attr("placeholder",u.frmplaceholder),e(".store-locator form button.button-erefill").html(u.btnfind),e(".store-locator form a.button-erefill").html(u.btnback),e(".store-locator .store-listing .store-info .button.select-store-button").text(u.btnselstore)},onDomReady:function(){function u(e){var t=window.location.search.substring(1),n=t.split("&");for(var r=0;r<n.length;r++){var i=n[r].split("=");if(i[0]==e)return i[1]}}var t=this,n,r,i,s,o;n=e(location).attr("href"),r=n.indexOf("c/"),i=n.indexOf("storelocator.html"),s=n.slice(r+2,i-1);var a=t.getUrlParameter("departments"),f=t.getUrlParameter("location"),l="/lcl-erefill-services/en_CA/store/location/"+f+"/department/300064/proximity/50/fetch/10";e("#form-store-locator").find("input[type=text]").val(f),e(".enlang").on("click",function(t){t.preventDefault(),o=window.location,o=o.replace(s,"en_CA"),window.location.href=e(this).attr("href")+"?location="+f}),e(".frlang").on("click",function(t){t.preventDefault(),o=window.location,o=o.replace(s,"fr_CA"),window.location.href=e(this).attr("href")+"?location="+f}),e("#form-store-locator").attr("data-storeloc",l),e.ajax({type:"GET",url:l,contentType:"application/x-www-form-urlencoded",done:function(t){t="["+decodeURIComponent(t)+"]",t=e.parseJSON(t),t&&t.length>0?(console.log("submit me"),$this.get(0).submit()):e(".noresults",$this).show()},fail:function(){console.log("fail")}}),window.google?(t.G=window.google.maps,t.initLocator()):(window.google_callback=function(){t.G=window.google.maps,t.initLocator()},require(["//maps.google.com/maps/api/js?sensor=false&callback=google_callback"]))},getUrlParameter:function(e){var t=window.location.search.substring(1),n=t.split("&");for(var r=0;r<n.length;r++){var i=n[r].split("=");if(i[0]==e)return i[1]}},initLocator:function(){var t=this,n=e("#form-store-locator"),r='.departments input[type="checkbox"]',u=n.find(r),a=e(".map_canvas"),f=h.mapDefaults,l={mapTypeId:t.G.MapTypeId[f.mapType],center:new t.G.LatLng(f.center.lat,f.center.lng),zoom:f.zoom};t.$formStoreSearch=n,t.$departments=u,u.filter('[value=""], :not([value])').attr("disabled","disabled").closest("li").addClass("disabled"),s.format=o,t.prevSearch="",t.infoWindows=[],t.btnFind=e(".btn-find",n),t.inputSearch=e(".input-search",n),t.storeListing=e(".main .store-listing"),t.map=new t.G.Map(a[0],l),t.markers=i({map:t.map}),t.currentLocation=null,!t.inputSearch.val()||t.inputSearch.val()===""?t.searchStores(h.defaultSearch):t.searchStores(t.inputSearch.val()),n.on("change",r,function(e){t.searchStores()}),e(".main-store-locator").on("click",".store-info .title a, .store-info .map-marker",function(n){n.preventDefault();var r=e(this).attr("data-identifier");t.markers.openInfoWindow("marker-"+r)})},searchStores:function(e){var t=this;e=e?e:t.inputSearch.val();if(e){var n=new t.G.Geocoder;n.geocode({address:e},function(n,r){if(r===t.G.GeocoderStatus.OK)try{t.currentLocation=n[0].geometry.location}catch(i){}else t.currentLocation=null;t.buildStoreList(e)})}},buildStoreList:function(t){var n=this,r,i=n.$formStoreSearch,s=n.$departments,o=i.find(".error"),u=i.find(".input-search"),a;n.mapBounds=new n.G.LatLngBounds,r=e.makeArray(s.filter(":checked").map(function(){return e(this).val()}));var f=i.attr("data-storeloc");n.xhr&&n.xhr.abort&&n.xhr.abort(),n.xhr=e.ajax({type:"GET",contentType:"application/x-www-form-urlencoded",url:f,success:function(r){r="["+decodeURIComponent(r)+"]",r=e.parseJSON(r);var i=r[0].stores;n.markers.clear(),n.storeListing.empty(),i&&i.length>0?(o.hide(),u.removeClass("input-error"),e.each(i,function(e,r){var i=String.fromCharCode(65+e);n.showResult(i,t,r)}),n.map.fitBounds(n.mapBounds)):(o.show(),u.addClass("input-error"))},error:function(e,t){console.log("Sample of error data:",t),console.log("readyState: "+e.readyState+"\nstatus: "+e.status+"\nresponseText: "+e.responseText)}})},showResult:function(t,r,i){var o=this,u=new o.G.LatLng(i.address.latitude,i.address.longitude),a=e.extend({identifier:t,identifierPin:n.uriTemplate(h.pinUrlTpl,{identifier:t}),fromAddress:r,distance:i.distance},i),f=e(s.render(a));o.localizetxt(),o.markers.createMarker(u,a),f.appendTo(o.storeListing).on("click","a.button",{id:i.id,storeNumber:i.storeNumber,storeProvince:i.address.province,storeName:i.storeName},o.onSelectStore),o.mapBounds.extend(u)},calculateDistanceTo:function(e){var t=this;if(!t.currentLocation)return"";var n=t.G.geometry.spherical.computeDistanceBetween(e,t.currentLocation)/1e3;return n.toFixed(1).replace(".0","")+"km"},onSelectStore:function(t){t.preventDefault();var n=e(this),i=n.attr("href");r.cookieManager.setCookie(a,t.data.id,h.cookieExpiry,"/",h.cookieDomain,!1),r.cookieManager.setCookie(f,t.data.storeNumber,h.cookieExpiry,"/",h.cookieDomain,!1),r.cookieManager.setCookie(c,t.data.storeProvince,h.cookieExpiry,"/",h.cookieDomain,!1),window.location.href=i}});return new p});